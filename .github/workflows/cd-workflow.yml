name: CD - Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ðŸ˜ Grant permission for gradlew
        run: chmod +x gradlew

      - name: ðŸ§ª Build without test
        run: ./gradlew clean build -x test

      - name: ðŸ“¦ Rename jar
        run: |
          JAR_FILE=$(ls build/libs/*.jar | head -n 1)
          mv "$JAR_FILE" build/libs/dopamine-market.jar

      - name: âœˆï¸ Upload jar to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          source: "build/libs/dopamine-market.jar"
          target: "/home/ec2-user/app/"

      - name: ðŸš€ SSH Deploy (kill & restart JAR)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          script: |
            echo "âš™ï¸ Move to app directory"
            cd /home/ec2-user/app

            echo "ðŸ›‘ Killing old process"
            pkill -f 'dopamine-market.jar' || true

            echo "ðŸš€ Starting new JAR"
            nohup java -jar dopamine-market.jar > log.out 2>&1 &